# Обяснение на услугата за прогноза на PV производството

Този документ описва как работи REST услугата, която изчислява очакваната почасова мощност на соларна станция. API-то е реализирано с **FastAPI** и комбинира физични модели за радиация, корекции на температура и машинно‑обучени модели за облачност.

## Какво прави услугата
- Приема параметри за конкретен масив от панели и дата за прогноза.
- Извлича метеорологични данни (облачност, температура, вятър и т.н.) от база или външен източник.
- Пресмята слънчевото излъчване върху плоскостта на панела (plane-of-array, POA) чрез **pvlib** и позицията на слънцето.
- Прилага ML модел за корекция на радиацията при наличие на облаци.
- Преобразува коригираната радиация в електрическа мощност за един панел и след това за целия масив.
- Връща времеви ред от точки с прогнозната мощност през деня.

## Основни стъпки на обработка
1. **Получаване на заявката** (`/predict` в `app.py`): валидира датата (`YYYY-MM-DD`) и идентификатора на панела (`topic`).
2. **Зареждане на спецификацията** (`tag_spec_loader.py`): чете координати, наклон, азимут, брой панели, площ и дата на въвеждане.
3. **Метеорологична прогноза** (`weather_api.py`): взема прогноза за деня за съответния обект и я интерполира на стъпка 15 минути.
4. **Clearsky радиация** (`radiation.py`): изчислява очакваната инсоляция върху панела според позицията на слънцето и геометрията.
5. **Корекция с ML модел** (`model_loader.py`):
   - Ако clearsky излъчването е над прага `THRESHOLD_RADIATION`, подава облачността и инцидентното излъчване на модел `*_model.pkl` от директория `Model/`.
   - Ако няма наличен модел за панела, услугата използва само физичния резултат.
6. **Преобразуване в мощност** (`production.py`):
   - Изчислява температурата на модула, отчита деградация и загуби по стрингове и инвертор.
   - Връща AC мощността на масива за всяка времева стъпка.
7. **Форматиране на резултата**: списък от `{ "x": <локално време Europe/Nicosia>, "y": <мощност в W> }`.

## API използване
- **Ендпойнт**: `POST /predict`
- **Тяло**:
  ```json
  {
    "prediction_date": "2025-03-20",
    "topic": "P0086H01/I002/Ptot"
  }
  ```
- **Отговор**: JSON масив от точки с мощност за деня.

## Конфигурация и зависимости
- Python 3.10+ и пакетите от `requirements.txt` (FastAPI, pandas, pvlib, scikit-learn, javaobj-py3 и др.).
- Път към моделите се задава с променливата `MODEL_DIR` (по подразбиране `Model/`).
- В Docker среда директорията с моделите се монтира в контейнера.

## Стартиране накратко
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app:app --reload
```
Swagger UI е достъпно на `http://localhost:8000/docs`.

## Ключови файлове
- `app.py` — FastAPI приложение и основен ендпойнт `/predict`.
- `radiation.py` — изчислява POA радиацията чрез pvlib.
- `production.py` — конвертира радиацията в AC мощност на системата.
- `model_loader.py` — зарежда ML моделите за корекция на облачност.
- `tag_spec_loader.py` — чете CSV със спецификации на панелите.
- `weather_api.py` — нормализира и подготвя метеорологичните данни.

Този документ може да се използва като кратко README за нови разработчици или оператори на услугата.
