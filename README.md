# Услуга за прогноза на производството на соларни панели

REST API на FastAPI за изчисляване на почасовата продукция на соларна станция по данни за местоположението и конфигурацията на панелите плюс прогноза за времето от база данни. Основният ендпойнт `/predict` връща времеви ред с очакваната мощност.

## Основни модули
- **`app.py`** — актуалната версия на API. Обработва заявки към `/predict`, извлича конфигурацията на панела, зарежда метеоданни и ML модел, изчислява осветеността и мощността на системата.
- **`radiation.py`** — изчислява чистото слънчево излъчване върху панела (POA) с `pvlib`, отчитайки координати, наклон и азимут.
- **`production.py`** — прилага корекция за температура/облачност и преобразува излъчването в сумарна мощност на масива с оглед ефективност, загуби в стрингове и инвертор.
- **`model_loader.py`** — зарежда файл `*_model.pkl` от каталога с модели (пътят се задава чрез `MODEL_DIR`, по подразбиране `Model/`) и го използва за корекция на радиацията; съдържа утилита `predict_power` за модели с 2 или 25 признака.
- **`tag_spec_loader.py`** — чете CSV файла със спецификации на тагове и подава данните на основния API.
- **`weather_api.py`** — извлича метеорологични прогнози от публичния Weather API, нормализира ги и добавя времеви признаци.
- **Инфраструктура**: `Dockerfile` за изграждане на образа и `docker-compose.yml` за старт на `uvicorn` с монтирана папка `Model/` с файловете на моделите.

## Поток на работа на `/predict` (актуалната версия в `app.py`)
1. Валидира датата (`YYYY-MM-DD`) и получава тага на панела (`topic`).
2. Чете спецификацията на панела от `tag_specification` (координати, геометрия, брой панели, дата на въвеждане в експлоатация и др.).
3. По `sm_user_object_id` извлича от `weather_data` прогнозата за времето за посочената дата и я интерполира на стъпка 15 минути.
4. Изчислява за всеки времеви шаг clearsky излъчването върху плоскостта на панела чрез `pvlib`.
5. Ако излъчването е над прага (`THRESHOLD_RADIATION = 40 W/m²`), подава радиацията и облачността към ML модела (ако е наличен) за корекция; иначе мощността става нула.
6. Превръща коригираната радиация в мощност на един панел (с площ и ефективност), после в мощност на системата чрез `calculate_system_production` (температура, облачност, загуби, деградация).
7. Връща списък точки `{ "x": <време>, "y": <мощност> }`.

## Стартиране и конфигурация
- **Зависимости**: Python 3.10+, пакетите от `requirements.txt` (FastAPI, uvicorn, pandas, pvlib, scikit‑learn, javaobj‑py3 и др.).
- **Променливи на средата**:
  - `MODEL_DIR` — път до каталога с файловете на моделите (по подразбиране `Model/`).

### Локално стартиране
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app:app --reload
```
API ще е достъпен на `http://localhost:8000` (Swagger UI — `/docs`).

### Стартиране с Docker
```bash
docker build -t pv-forecast .
docker run -p 8000:8000 --env-file .env -v $(pwd)/Model:/app/Model pv-forecast
```
или чрез Compose:
```bash
docker-compose up --build
```

## Примерна заявка
```bash
curl -X POST http://localhost:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"prediction_date": "2025-03-20", "topic": "P0086H01/I002/Ptot"}'
```
Отговорът съдържа списък точки за мощността, където времето е в локалната зона `Europe/Nicosia`.

## Структура на репозитория
- **Коренови Python модули**
  - `app.py` — основният FastAPI сервис с ендпойнтовете `/`, `/tags` и `/predict`.
  - `radiation.py` — функции за изчисляване на слънчевото излъчване върху панела чрез `pvlib`.
  - `production.py` — преобразуване на излъчването в мощност, като се отчитат облачност, температура и деградация.
  - `weather_api.py` — клиент за Weather API, нормализация на данните и извличане на исторически записи.
  - `tag_spec_loader.py` — зарежда и валидира CSV със спецификации на таговете.
  - `model_loader.py` — зареждане на ML модели (`*_model.pkl`) и изчисление на коригирана мощност.
  - `frontend.html` — статична страница за ръчно избиране на обект и дата с визуализации на резултата.

- **Данни и модели**
  - `Model/` — продукционни модели, които се монтират в контейнера (пример: `P0063H01_E001_model.pkl`).
  - `models/` — локални/експериментални модели, използвани при разработка (`rf_model_v3.pkl`).
  - `data/` — примерни CSV файлове с прогнози, хронологии и спецификации (`weather_uid_70_full.csv`, `tag_spec.csv` и др.).

- **Инфраструктура и конфигурация**
  - `Dockerfile` и `docker-compose.yml` — изграждане и стартиране на приложението в контейнер.
  - `.dockerignore`, `.gitignore` — списъци с файлове/директории, които се пропускат при build или комит.
  - `deploy.sh` — скрипт за създаване на виртуална среда, инсталиране на зависимости и стартиране на `uvicorn`.
  - `requirements.txt` — списък със зависимостите на Python.
  - `pytest.ini` — базова конфигурация за тестовете.
  - `pep.txt` — празен placeholder файл (например за бележки по стил или PEP). 

- **Помощни ресурси**
  - `scripts/` — Jupyter notebook-и за анализ и подготовка на данните (`training.ipynb`, `dataset.ipynb` и др.).
  - `tests/` — pytest тестове за основните изчислителни модули (`test_radiation.py`, `test_production.py`, `test_app.py`).
  - `README.md`, `README_BG.md` — основната документация (текущият файл и български вариант за преглед).
  - `frontend.html` — статична демонстрация на UI, който чете ендпойнта `/predict` (споменат по-горе за пълнота).
