# Услуга за прогноза на производството на соларни панели

REST API на FastAPI за изчисляване на почасовата продукция на соларна станция по данни за местоположението и конфигурацията на панелите плюс прогноза за времето от база данни. Основният ендпойнт `/predict` връща времеви ред с очакваната мощност.

## Основни модули
- **`app.py`** — актуалната версия на API. Обработва заявки към `/predict`, извлича конфигурацията на панела, зарежда метеоданни и ML модел, изчислява осветеността и мощността на системата.
- **`app1.py`** — предишен вариант на обработчика `/predict` с подобна логика; оставен за съвместимост или отладка.
- **`database.py`** — свързва се с PostgreSQL (`archive_main`) и изтегля спецификацията на панела по таг от таблицата `tag_specification`.
- **`weather_db.py`** — свързва се с PostgreSQL (`solar_db`), десериализира бинарните Java обекти за време, нормализира ги в 15‑минутен интервал и връща списък записи.
- **`radiation.py`** — изчислява чистото слънчево излъчване върху панела (POA) с `pvlib`, отчитайки координати, наклон и азимут.
- **`production.py`** — прилага корекция за температура/облачност и преобразува излъчването в сумарна мощност на масива с оглед ефективност, загуби в стрингове и инвертор.
- **`model_loader.py`** — зарежда файл `*_model.pkl` от каталога с модели (пътят се задава чрез `MODEL_DIR`, по подразбиране `Model/`) и го използва за корекция на радиацията; съдържа утилита `predict_power` за модели с 2 или 25 признака.
- **`weather.py`** — алтернативен модул за извличане на прогноза от друга БД (`solar_main2`); не се ползва в текущия `app.py`, но е полезен при миграция.
- **`test_radiation.py`** — скрипт за ръчна отладка на изчисленията на излъчване/мощност (ползва остарялата функция `calculate_panel_power`).
- **Инфраструктура**: `Dockerfile` за изграждане на образа и `docker-compose.yml` за старт на `uvicorn` с монтирана папка `Model/` с файловете на моделите.

## Поток на работа на `/predict` (актуалната версия в `app.py`)
1. Валидира датата (`YYYY-MM-DD`) и получава тага на панела (`topic`).
2. Чете спецификацията на панела от `tag_specification` (координати, геометрия, брой панели, дата на въвеждане в експлоатация и др.).
3. По `sm_user_object_id` извлича от `weather_data` прогнозата за времето за посочената дата и я интерполира на стъпка 15 минути.
4. Изчислява за всеки времеви шаг clearsky излъчването върху плоскостта на панела чрез `pvlib`.
5. Ако излъчването е над прага (`THRESHOLD_RADIATION = 40 W/m²`), подава радиацията и облачността към ML модела (ако е наличен) за корекция; иначе мощността става нула.
6. Превръща коригираната радиация в мощност на един панел (с площ и ефективност), после в мощност на системата чрез `calculate_system_production` (температура, облачност, загуби, деградация).
7. Връща списък точки `{ "x": <време>, "y": <мощност> }`.

## Стартиране и конфигурация
- **Зависимости**: Python 3.10+, пакетите от `requirements.txt` (FastAPI, uvicorn, pandas, pvlib, sqlalchemy, scikit‑learn, javaobj‑py3 и др.).
- **Променливи на средата**:
  - `MODEL_DIR` — път до каталога с файловете на моделите (по подразбиране `Model/`).
  - При нужда презапишете връзките към PostgreSQL в `database.py` и `weather_db.py` чрез собствени променливи на средата или секрети на контейнера.

### Локално стартиране
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app:app --reload
```
API ще е достъпен на `http://localhost:8000` (Swagger UI — `/docs`).

### Стартиране с Docker
```bash
docker build -t pv-forecast .
docker run -p 8000:8000 --env-file .env -v $(pwd)/Model:/app/Model pv-forecast
```
или чрез Compose:
```bash
docker-compose up --build
```

## Примерна заявка
```bash
curl -X POST http://localhost:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"prediction_date": "2025-03-20", "topic": "P0086H01/I002/Ptot"}'
```
Отговорът съдържа списък точки за мощността, където времето е в локалната зона `Europe/Nicosia`.

## Структура на репозитория
```
├── app.py              # Основен API сервис
├── app1.py             # Алтернативен ендпойнт /predict
├── database.py         # Зареждане на спецификации от archive_main
├── weather_db.py       # Получаване на прогноза за времето от solar_db
├── radiation.py        # Изчисляване на слънчевото излъчване чрез pvlib
├── production.py       # Превод на излъчването в мощност на системата
├── model_loader.py     # Зареждане на ML модели (.pkl)
├── weather.py          # Алтернативен източник на прогноза (solar_main2)
├── Dockerfile, docker-compose.yml
├── requirements.txt
└── Model/              # Каталог с модели (монтира се в контейнера)
```
