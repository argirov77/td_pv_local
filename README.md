# Сервис прогноза выработки солнечных панелей

REST API на FastAPI для расчёта почасовой выработки солнечной станции по данным о местоположении панелей, их конфигурации и прогнозу погоды из БД. Основной эндпоинт `/predict` возвращает временной ряд ожидаемой мощности.

## Основные модули
- **`app.py`** — актуальная версия API. Обрабатывает запросы `/predict`, извлекает конфигурацию панели, загружает метеоданные и ML‑модель, вычисляет освещённость и мощность системы.
- **`app1.py`** — предыдущий вариант обработчика `/predict` с похожей логикой; оставлен для совместимости или отладки.
- **`database.py`** — подключается к PostgreSQL (`archive_main`) и вытаскивает спецификацию панели по тегу из таблицы `tag_specification`.
- **`weather_db.py`** — подключается к PostgreSQL (`solar_db`), десериализует бинарные Java‑объекты погоды, нормализует их в 15‑минутный шаг и возвращает список записей.
- **`radiation.py`** — рассчитывает чистое солнечное излучение на панели (POA) с помощью `pvlib` с учётом координат, наклона и азимута.
- **`production.py`** — применяет поправку на температуру/облачность и преобразует излучение в суммарную мощность массива с учётом эффективности, потерь в струнных соединениях и инверторе.
- **`model_loader.py`** — загружает файл `*_model.pkl` из каталога моделей (путь задаётся `MODEL_DIR`, по умолчанию `Model/`) и использует его для корректировки радиации; содержит утилиту `predict_power` для моделей с 2 или 25 признаками.
- **`weather.py`** — альтернативный модуль извлечения погоды из другой БД (`solar_main2`); не используется в текущем `app.py`, но может пригодиться для миграции.
- **`test_radiation.py`** — скрипт для ручной отладки расчёта излучения/мощности (использует устаревшую функцию `calculate_panel_power`).
- **Инфраструктура**: `Dockerfile` для сборки образа, `docker-compose.yml` для запуска `uvicorn` с примонтированной папкой `Model/` с файлами моделей.

## Поток работы `/predict` (актуальная версия из `app.py`)
1. Валидирует дату (`YYYY-MM-DD`) и получает тег панели (`topic`).
2. Читает спецификацию панели из `tag_specification` (координаты, геометрия, количество панелей, дата ввода в эксплуатацию и т.д.).
3. По `sm_user_object_id` извлекает из `weather_data` прогноз погоды на указанную дату и интерполирует его на шаг 15 минут.
4. Рассчитывает для каждого временного шага clearsky‑излучение на плоскость панели через `pvlib`.
5. Если излучение выше порога (`THRESHOLD_RADIATION = 40 W/m²`), передаёт радиацию и облачность в ML‑модель (если она есть) для корректировки; иначе мощность приравнивается к нулю.
6. Переводит скорректированное излучение в мощность одной панели (учёт площади и эффективности), затем в мощность системы через `calculate_system_production` (температура, облачность, потери, деградация).
7. Возвращает список точек `{ "x": <время>, "y": <мощность> }`.

## Запуск и конфигурация
- **Зависимости**: Python 3.10+, пакеты из `requirements.txt` (FastAPI, uvicorn, pandas, pvlib, sqlalchemy, scikit‑learn, javaobj‑py3 и др.).
- **Переменные окружения**:
  - `MODEL_DIR` — путь к каталогу с файлами моделей (по умолчанию `Model/`).
  - При необходимости переопределите строки подключения к PostgreSQL в `database.py` и `weather_db.py` через собственные переменные окружения или секреты контейнера.

### Локальный запуск
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app:app --reload
```
API будет доступен на `http://localhost:8000` (Swagger UI — `/docs`).

### Запуск в Docker
```bash
docker build -t pv-forecast .
docker run -p 8000:8000 --env-file .env -v $(pwd)/Model:/app/Model pv-forecast
```
или через Compose:
```bash
docker-compose up --build
```

## Пример запроса
```bash
curl -X POST http://localhost:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"prediction_date": "2025-03-20", "topic": "P0086H01/I002/Ptot"}'
```
В ответе придёт список точек мощности, где время соответствует локальной зоне `Europe/Nicosia`.

## Структура репозитория
```
├── app.py              # Основной API сервис
├── app1.py             # Альтернативный эндпоинт /predict
├── database.py         # Загрузка спецификаций из archive_main
├── weather_db.py       # Получение прогноза погоды из solar_db
├── radiation.py        # Расчёт солнечного излучения через pvlib
├── production.py       # Перевод излучения в мощность системы
├── model_loader.py     # Загрузка ML-моделей (.pkl)
├── weather.py          # Альтернативный источник погоды (solar_main2)
├── Dockerfile, docker-compose.yml
├── requirements.txt
└── Model/              # Каталог с моделями (монтируется в контейнер)
```
