<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PV Прогноза</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            color-scheme: light;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        body {
            background: #f4f6fb;
            margin: 0;
            padding: 0;
            color: #1f2933;
        }
        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 16px 48px;
        }
        h1 {
            margin-bottom: 8px;
        }
        p.helper {
            color: #5f6b7a;
            margin-top: 0;
            margin-bottom: 24px;
        }
        form {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(31, 41, 51, 0.08);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            align-items: end;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        select, input[type=date] {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #d6d9e0;
            font-size: 14px;
        }
        button {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #1d4ed8; }
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(31, 41, 51, 0.08);
            margin-top: 20px;
        }
        .chart-area { position: relative; width: 100%; height: 260px; }
        canvas { width: 100% !important; height: 100% !important; }
        .status { margin-top: 12px; color: #5f6b7a; font-size: 14px; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .chart-block h4 { margin: 0 0 8px 0; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 14px;
        }
        th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        th { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="page">
        <h1>Прогноза за производство</h1>
        <p class="helper">Изберете обект и дата, за да получите 15-минутна прогноза за мощността (W).</p>
        <form id="predict-form">
            <label>
                Обект
                <select id="tag-select" required></select>
            </label>
            <label>
                Дата
                <input id="date-input" type="date" required />
            </label>
            <button type="submit" id="submit-btn">Покажи прогноза</button>
        </form>

        <div class="card">
            <h3 style="margin-top: 0;">Прогнозни графики</h3>
            <div class="charts-grid">
                <div class="chart-block">
                    <h4>Радиация (чисто небе)</h4>
                    <div class="chart-area"><canvas id="radiation-chart"></canvas></div>
                </div>
                <div class="chart-block">
                    <h4>Облачност (%)</h4>
                    <div class="chart-area"><canvas id="cloud-chart"></canvas></div>
                </div>
                <div class="chart-block">
                    <h4>Температура (°C)</h4>
                    <div class="chart-area"><canvas id="temperature-chart"></canvas></div>
                </div>
                <div class="chart-block">
                    <h4>Производство при идеални условия (W)</h4>
                    <div class="chart-area"><canvas id="ideal-chart"></canvas></div>
                </div>
                <div class="chart-block">
                    <h4>Прогнозна мощност (с облаци и температура)</h4>
                    <div class="chart-area"><canvas id="power-chart"></canvas></div>
                </div>
            </div>
            <div class="status" id="status">Заредете данните, за да видите графиките.</div>
            <div id="table-wrapper"></div>
        </div>
    </div>

    <script>
        const tagSelect = document.getElementById('tag-select');
        const dateInput = document.getElementById('date-input');
        const form = document.getElementById('predict-form');
        const statusEl = document.getElementById('status');
        const submitBtn = document.getElementById('submit-btn');
        const tableWrapper = document.getElementById('table-wrapper');
        const chartRefs = {
            radiation: null,
            cloud: null,
            temperature: null,
            ideal_power: null,
            predicted_power: null,
        };

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            submitBtn.textContent = isLoading ? 'Зареждане...' : 'Покажи прогноза';
        }

        function populateTags(tagOptions) {
            tagSelect.innerHTML = '';
            if (!tagOptions.length) {
                const opt = document.createElement('option');
                opt.textContent = 'Няма налични обекти';
                opt.disabled = true;
                opt.selected = true;
                tagSelect.appendChild(opt);
                submitBtn.disabled = true;
                return;
            }
            tagOptions.forEach((item) => {
                const opt = document.createElement('option');
                const type = item.tag_type ? ' (' + item.tag_type + ')' : '';
                opt.value = item.tag;
                opt.textContent = item.tag + type;
                tagSelect.appendChild(opt);
            });
            submitBtn.disabled = false;
        }

        async function loadTags() {
            tagSelect.innerHTML = '';
            const loadingOption = document.createElement('option');
            loadingOption.textContent = 'Зареждане на обекти...';
            loadingOption.disabled = true;
            loadingOption.selected = true;
            tagSelect.appendChild(loadingOption);
            submitBtn.disabled = true;

            try {
                const response = await fetch('/tags');
                if (!response.ok) {
                    throw new Error('Неуспешно зареждане на списъка с тагове');
                }
                const payload = await response.json();
                const tagOptions = Array.isArray(payload.tags) ? payload.tags : [];
                populateTags(tagOptions);
            } catch (err) {
                console.error(err);
                tagSelect.innerHTML = '';
                const opt = document.createElement('option');
                opt.textContent = err.message;
                opt.disabled = true;
                opt.selected = true;
                tagSelect.appendChild(opt);
                submitBtn.disabled = true;
            }
        }

        function renderLineChart({ canvasId, label, labels, data, color, yLabel, key }) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const refKey = key || canvasId;
            if (chartRefs[refKey]) {
                chartRefs[refKey].destroy();
            }
            chartRefs[refKey] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data,
                        fill: true,
                        borderColor: color,
                        backgroundColor: color + '22',
                        tension: 0.25,
                        pointRadius: 1.5,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxRotation: 45, minRotation: 45 } },
                        y: { beginAtZero: true, title: { display: !!yLabel, text: yLabel || '' } },
                    },
                },
            });
        }

        function renderCharts(payload) {
            const labels = payload.time || [];
            renderLineChart({
                canvasId: 'radiation-chart',
                label: 'Радиация W/m²',
                key: 'radiation',
                labels,
                data: payload.radiation || [],
                color: '#f59e0b',
                yLabel: 'W/m²',
            });
            renderLineChart({
                canvasId: 'cloud-chart',
                label: 'Облачност (%)',
                key: 'cloud',
                labels,
                data: payload.cloud || [],
                color: '#64748b',
                yLabel: '%',
            });
            renderLineChart({
                canvasId: 'temperature-chart',
                label: 'Температура (°C)',
                key: 'temperature',
                labels,
                data: payload.temperature || [],
                color: '#ef4444',
                yLabel: '°C',
            });
            renderLineChart({
                canvasId: 'ideal-chart',
                label: 'Идеално производство (W)',
                key: 'ideal_power',
                labels,
                data: payload.ideal_power || [],
                color: '#22c55e',
                yLabel: 'W',
            });
            renderLineChart({
                canvasId: 'power-chart',
                label: 'Прогнозна мощност (W)',
                key: 'predicted_power',
                labels,
                data: payload.predicted_power || [],
                color: '#2563eb',
                yLabel: 'W',
            });
        }

        function renderTable(payload) {
            const labels = payload.time || [];
            const rowsCount = labels.length;
            if (!rowsCount) {
                tableWrapper.innerHTML = '';
                return;
            }
            const rows = labels
                .map((time, idx) => {
                    const radiation = payload.radiation?.[idx] ?? '—';
                    const cloud = payload.cloud?.[idx] ?? '—';
                    const temp = payload.temperature?.[idx] ?? '—';
                    const ideal = payload.ideal_power?.[idx] ?? '—';
                    const predicted = payload.predicted_power?.[idx] ?? '—';
                    return `<tr><td>${time}</td><td>${radiation}</td><td>${cloud}</td><td>${temp}</td><td>${ideal}</td><td>${predicted}</td></tr>`;
                })
                .join('');
            tableWrapper.innerHTML = `
                <table>
                    <thead><tr><th>Време</th><th>Радиация</th><th>Облачност (%)</th><th>Температура (°C)</th><th>Идеално производство (W)</th><th>Прогнозна мощност (W)</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>`;
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const tag = tagSelect.value;
            const prediction_date = dateInput.value;
            if (!tag || !prediction_date) {
                statusEl.textContent = 'Посочете обект и дата.';
                return;
            }

            setLoading(true);
            statusEl.textContent = 'Заявка за прогноза...';
            tableWrapper.innerHTML = '';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: tag, prediction_date }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Неуспешна заявка' }));
                    throw new Error(error.detail || 'Неуспешно получаване на прогноза');
                }

                const data = await response.json();
                const pointsCount = Array.isArray(data.time) ? data.time.length : 0;
                if (!pointsCount) {
                    statusEl.textContent = 'Няма данни за избраните параметри.';
                    renderTable({ time: [] });
                    return;
                }

                renderCharts(data);
                renderTable(data);
                statusEl.textContent = `Получени са ${pointsCount} точки.`;
            } catch (err) {
                console.error(err);
                statusEl.textContent = err.message;
                renderTable({ time: [] });
            } finally {
                setLoading(false);
            }
        });

        (function init() {
            loadTags();
            const today = new Date().toISOString().slice(0, 10);
            dateInput.value = today;
        })();
    </script>
</body>
</html>
